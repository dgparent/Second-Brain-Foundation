name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (or "all" for all packages)'
        required: true
        default: 'all'

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event.inputs.package != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: npm ci --production=false
      
      - name: Build packages
        run: npm run build
      
      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.package }}" = "all" ] || [ "${{ github.event_name }}" = "release" ]; then
            echo "Publishing all packages..."
            npm run publish:all || echo "Publish script not configured"
          else
            echo "Publishing package: ${{ github.event.inputs.package }}"
            cd packages/@sbf/${{ github.event.inputs.package }}
            npm publish --access public
          fi
  
  create-plugin-registry:
    runs-on: ubuntu-latest
    needs: publish-npm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Generate plugin registry
        run: |
          echo "Generating plugin registry..."
          node scripts/generate-plugin-registry.js || echo "Registry script not configured"
      
      - name: Upload registry
        uses: actions/upload-artifact@v3
        with:
          name: plugin-registry
          path: plugin-registry.json
